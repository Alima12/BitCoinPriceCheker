import requests as req
import sqlite3
from connectToDb import insert,min_max_today,min_max_yesterday,growth,Most,Least,data
from telegram.ext import Updater
from datetime import datetime
from chart import draw_chart


#ูุตู ุดุฏู ุจู ุฑุจุงุช
updater = Updater(token='1716430763:AAEuqY-YqLMfYO5PKU_lkJ73bJ4PvxLjGSs', use_context=True)

#ฺฏุฑูุชู ุฑุจุงุช ุจุฑุง ุงุณุชูุงุฏู ูุณุชูู ุงุฒ ุฏุณุชูุฑุงุช
bot = updater.bot


#ุงู ูุชูุฏ ุจุฑุง ุงุฑุณุงู ุงุนูุงู ุงุณุชูุงุฏู ูุดู
def send_notif(message):
    # ฺฏุฑูุชู ุฏุชุง ุจุฑุง ฺฉุดุฏู ูููุฏุงุฑ ถ ุณุงุนุช ุงุฎุฑ
    datas = data()

    #ุนููุงุช ฺฉุดุฏู ูููุฏุงุฑ ู ุฐุฎุฑู ุนฺฉุณ
    # ุนฺฉุณ ุฑู ุจุง ุงุณู chart.jpg ุชู ุฑูุช ุฒุฎุฑู ูฺฉูู
    draw_chart(datas)
    message = "๐ชุชุบุฑุงุช ููุช ุฏุฑ 6 ุณุงุนุช ุงุฎุฑ๐ฅ \n\n" + message

    #ุจุงุฒ ฺฉุฑุฏู ุนฺฉุณ ูููุฏุงุฑ ุจุฑุง ุงุฑุณุงู 
    #ุงุฑุณุงู ุนฺฉุณ ุจู ฺฉุงุฑุจุฑุงู ุงูุชุฎุงุจ
    with open('chart.jpg','rb') as file:
        bot.send_photo(88171378,photo=file,caption=message)
        bot.send_photo(-1001341117324,photo=file,caption=message)
        bot.send_photo(1074680699,photo=file,caption=message)


#ุงู ูุชูุฏ ุฏุฑุตุฏ ุฑุดุฏ ุจุช ฺฉูู ุฑู ูุญุงุณุจู ูฺฉูุฏ ุฏุฑ ุจุงุฒู ูุง ุฒูุงู ูุฎุชูู
#ููุช ฺฉููู ุฑุง ุฏุฑุงูุช ูฺฉูุฏ

"""
ุงู ูุชูุฏ ุงููู ููุช ุจุงุฒู
 ููุฑุฏ ูุธุฑ ุฑุง ุฏุฑ ููุงู ุฑูุฒ - ุจุทูุฑ ูุซุงู:
 ุงููู ููุช ฺฉู ณฐ ุฑูุฒ ูพุด ุซุจุช ุดุฏู ุจุงุดุฏ
 ุฑุง ูฺฏุฑู ู ุจุง ููุช ฺฉููู ููุงุณู ูฺฉูุฏ
 ู ุฏุฑุตุฏ ุฑุดุฏ ุฑุง ูุญุณุงุจู ูฺฉูุฏ
"""
def get_growth(price):
    days = [0,3,7,30]
    text = "\n\nโก๏ธูุฒุงู ุฑุดุฏ:\n\n"

    #ููุท ูุชู ุงุฑุณุงู ุฑุง ุฒุจุง ูฺฉูู
    def change_form(dif):
        dif = str(dif)
        if '-' in dif:
            dif = dif.replace('-','')
            dif = dif + 'โ '
        else:
            dif = dif +  "โ " 

        return dif
    
    #ุณู ุจุงุฒู ุฒูุงู 3,7 ู 30 ุฑู ุจุฑุฑุณ ูฺฉูู ู ุฏุฑุตุฏ ุฑุดุฏุดูู ุฑู ูุญุณุงุจู ูฺฉูู
    for day in days:
        dif = growth(day,price)
        if day == 0:
            dif = change_form(dif)
            t= f"โ๏ธ ุงูุฑูุฒ => %{dif}\n"
        else:
            dif = change_form(dif)
            t= f"๐ ุงุฒ {day} ุฑูุฒ ูพุด => %{dif}\n"
        text += t
    return text


#  ุจุดุชุฑู ู ฺฉูุชุฑู ููุช ุงูุฑูุฒ ู ุฏุฑูุฒ ุฑุง ุจุฑูฺฏุฑุฏุงูุฏ
def more_detail():
    #ุจุดุชุฑู ู ฺฉูุชุฑู ููุช ุงูุฑูุฒ
    min_t,max_t = min_max_today()
    #ุจุดุชุฑู ู ฺฉูุชุฑู ููุช ุฏุฑูุฒ
    min_y,max_y = min_max_yesterday()
    text = f"\n\n ๐ต๐ุจุดุชุฑ๐๐ต\n\n๐ฅฺฉูุชุฑู ููุช ุงูุฑูุฒ => {min_t}\n๐ฅุจุดุชุฑู ููุช ุงูุฑูุฒ=> {max_t}\n\n๐ฅุจุดุชุฑู ููุช ุฏุฑูุฒ=> {min_y}\n๐ฅฺฉูุชุฑู  ููุช ุฏุฑูุฒ => {max_y} \n\n\n"
    return text

#ูุณุชู ุงุตู ุงู ุจุฑูุงูู
#ููุช ุฑุง ฺฏุฑูุชู ู ุจู ูพุงฺฏุงู ุฏุงุฏู ูุฏูุฏ
#ููุช ุฑุง ฺฺฉ ูฺฉูุฏ ู ุฏุฑ ุตูุฑุช ุจุฑูุฑุงุฑ ุจูุฏู ุดุฑุท ุงุนูุงู ุฑุง ุตุฏุง ูุฒูุฏ
def set_price():
    url = "https://blockchain.info/ticker"
    response = req.get(url)
    response = response.json()
    #ุฌุฏุง ฺฉุฑุฏู ููุช ุฏูุงุฑ
    price = response["USD"]
    #ฺฏุฑูุชู ููุช ุฎุฑุฏ ุจุช ฺฉูู
    buy_price = price["buy"]
    # ูุณุช ูพุงู ูุง ฺฉู ุฏุฑ ุตูุฑุช ฺฉู ุฑูุฏุงุฏ ุฑุฎ ูุฏุงุฏู ุจุงุดุฏ ุชุนุฏุงุฏ ุงุนุถุง ุขู ฺฉ ูุจุงุดุฏ
    message = []
    #ุนููุงู ูพุงู ุงุฑุณุงู ุจุฑุง ุงุฑุณุงู ุงุนูุงู
    title = f"๐ููุช ฺฉููู ุจุชฺฉูู=>   {buy_price} ุฏูุงุฑ \n"
    message.append(title)
    """
    ุณู ุจุงุฒู ุฒูุงู 3 ู 7 ู 30 ุฑูุฒ ุฑุง ฺฺฉ ูฺฉูุฏ
    ุงฺฏุฑ ููุช ฺฉููู ฺฉู ุฏุฑ ุจุงูุง ฺฏุฑูุชู ุดุฏ
    ฺฉูุชุฑู ุง ุจุดุชุฑู ููุช ุฏุฑ ุขู ุจุงุฒู ุฒูุงู ุจุงุดุฏ
    ฺฉ ุฑูุฏุงุฏ ุฑุง ุจู ุงุนูุงู ูุง ุงุถุงูู ูฺฉูุฏ
    """
    for day in [3,7,30]:
        #ุงฺฏุฑ ููุช ฺฉููู ุจุดุชุฑู ููุช ุฏุฑ ุจุงุฒู ุฒูุงู ุจุงุดุฏ
        if Most(buy_price,day):
            message.append(f"๐ ุจุดุชุฑู ููุช ุฏุฑ  {day} ุฑูุฒ ฺฏุฐุดุชู")
        #ุงฺฏุฑ ููุช ฺฉูุชุฑู ููุช ุฏุฑ ุจุงุฒู ุฒูุงู ุจุงุดุฏ
        if Least(buy_price,day):
            message.append(f"๐ ฺฉูุชุฑู ููุช ุฏุฑ {day} ุฑูุฒ ฺฏุฐุดุชู")

    #ุจุนุฏ ุงุฒ ฺฺฉ ฺฉุฑุฏู ููุช ู ุณุช ฺฉุฑุฏู ุงุนูุงู ูุง ููุช ฺฉููู ุฑุง ูุฒ ุจู ูพุงฺฏุงู ุฏุงุฏู ุงุถุงูู ูฺฉูุฏ 
    insert(price["buy"],price["sell"])


    #ฺฺฉ ูุดูุฏ ุงฺฏุฑ ุชุนุฏุงุฏ ุงุนุถุง ูุณุช ูพุงู ุจุดุชุฑ ุงุฒ  1 ุจุงุดุฏ
    #ฺฉู ุจู ุงู ูุนู ูุณุช ุฑูุฏุงุฏ ุฑุฎ ุฏุงุฏู ุงุณุช
    #ุฏุฑ ุงู ุตูุฑุช ุงุนูุงู ุฑุง ุขูุงุฏู ู ุงุฑุณุงู ูฺฉูุฏ
    if len(message) > 1:
        #ฺฏุฑูุชู ุฌุฒูุงุช ุจุดุชุฑ ูุซู ฺฉูุชุฑู ู  ุจุดุชุฑู ููุช ุฏุฑ ุฏุฑูุฒ ู ุงูุฑูุฒ
        more = more_detail()
        message.append(more)
        #ูุญุณุงุจู ุฏุฑุตุฏ ุฑุดุฏ
        gro = get_growth(buy_price)
        message.append(gro)
        #ฺฏุฑูุชู ุฒูุงู ู ุงุถุงูู ฺฉุฑุฏู ุขู ุจู ุงูุชูุง ูุณุช ูพุงู 
        __time = datetime.now().strftime("%H:%M:%S")
        message.append(__time)
        #ูุณุช ุฑุง ุจู ุตูุฑุช ุฑุดุชู ุฏุฑ ูุงุฑู ุชุง ูุงุจู ุงุฑุณุงู ุจู ุนููุงู ุงุนูุงู ุจุงุดุฏ
        msg = '\n'.join(message)
        #ุฏุงุฏู ูุชู ุขูุงุฏู ุจู ูุชูุฏ ุงุฑุณุงู ุงุนูุงู
        send_notif(msg)



if __name__ == "__main__":
    set_price()
